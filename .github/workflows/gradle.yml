name: Java Build & Test

on:
  push:
    branches:
      - '**'  # Build on all branches
    tags:
      - 'v*.*.*'
  pull_request:
    types: [opened, synchronize, labeled, reopened]
  workflow_dispatch:

permissions:
  contents: read
  checks: write
  pull-requests: write # Required for the bot to comment on PRs

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./core-banking-services
    
    # Run on all Pushes, all Dispatch, or PRs (standard CI practice is to run tests on ALL PRs, unlike Docker which might only be for previews)
    if: |
      github.event_name == 'push' || 
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          # This enables automatic dependency caching (similar to cache-from in Docker)
          cache: 'gradle'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
           # Fail if the build wrapper file has changed (security feature)
           gradle-version: wrapper
           build-root-directory: core-banking-services

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Build with Gradle
        id: build
        run: ./gradlew build -x test # Build first, separate test step allows for better reporting

      - name: Run Tests
        id: test
        run: ./gradlew test

      - name: Extract Artifact Info
        id: artifact_info
        run: |
          JAR_PATH=$(find build/libs -name "*.jar" ! -name "*-plain.jar" | head -n 1)
          JAR_NAME=$(basename "$JAR_PATH")
          echo "jar_path=$JAR_PATH" >> $GITHUB_OUTPUT
          echo "jar_name=$JAR_NAME" >> $GITHUB_OUTPUT
          echo "build_time=$(date)" >> $GITHUB_OUTPUT

      # Feature: Upload the JAR similar to how Docker pushes an image
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: application-jar
          path: ${{ steps.artifact_info.outputs.jar_path }}
          retention-days: 5

      # Feature: Job Summary (Markdown report in Actions UI)
      - name: Create Build Summary
        if: always() # Run even if tests fail
        run: |
          echo "## â˜• Java Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | ${{ job.status == 'success' && 'âœ… Success' || 'âŒ Failure' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Artifact** | \`${{ steps.artifact_info.outputs.jar_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" == "success" ]; then
             echo "### ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
             echo "The JAR file has been uploaded to the [Summary Tab](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})." >> $GITHUB_STEP_SUMMARY
          fi

      # Feature: PR Comment (The "Killer Feature" from your Docker workflow)
      - name: Comment on PR with Test Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const buildStatus = '${{ job.status }}' === 'success' ? 'âœ… Passed' : 'âŒ Failed';
            const jarName = '${{ steps.artifact_info.outputs.jar_name }}';
            
            const comment = `## â˜• Java Build & Test Results
            
            | Category | Status |
            | :--- | :--- |
            | **Build Status** | ${buildStatus} |
            | **Artifact Name** | \`${jarName}\` |
            
            ### ðŸ” Next Steps
            
            1. **Download:** You can download the JAR from the [Actions Artifacts Section](${context.payload.repository.html_url}/actions/runs/${context.runId}).
            2. **Logs:** View the full build logs [here](${context.payload.repository.html_url}/actions/runs/${context.runId}).
            
            > *Run executed on commit ${context.sha.substring(0, 7)}*
            `;
            
            // Check for existing bot comment to update instead of spamming
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Java Build & Test Results')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
